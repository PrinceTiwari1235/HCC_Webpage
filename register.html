<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admissions Registration - HCC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
</head>
<body class="bg-blue-50 min-h-screen flex flex-col">
  <header class="bg-white shadow-lg sticky top-0 z-50">
    <div class="container mx-auto flex flex-row items-center justify-between py-4 px-6">
      <div class="flex items-center gap-4">
        <div class="rounded-full overflow-hidden border-2 border-blue-500 shadow-md">
          <img src="Image/logo_of_HCC.jpg" alt="Hetauda_City_College_Logo" class="w-12 h-12 object-cover" />
        </div>
        <div class="flex flex-col items-center justify-center text-center">
          <h1 class="text-lg sm:text-xl font-bold text-blue-700 tracking-wide">Hetauda City College / Zenith</h1>
        </div>
      </div>
      <a href="hcc.html" class="text-blue-600 font-semibold hover:underline">Back to Home</a>
    </div>
  </header>
  <main class="flex-1 flex items-center justify-center py-12 px-4">
    <div class="relative w-full flex items-center justify-center min-h-[600px]">
      <!-- Video Background -->
      <video autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover rounded-2xl z-0 brightness-75">
        <source src="https://www.pexels.com/video/8571957/download/?fps=25.0&h=720&w=1280" type="video/mp4" />
        Your browser does not support the video tag.
      </video>
      <!-- Form Content -->
      <div class="relative z-10 bg-white bg-opacity-90 rounded-2xl shadow-2xl p-10 max-w-3xl w-full mx-auto">
        <h2 class="text-2xl font-extrabold text-blue-700 mb-6 text-center">Admissions Registration Form</h2>
        <!-- Add loading and error states -->
        <div id="formStatus" class="mb-4 hidden">
          <p id="loadingMessage" class="text-blue-600 text-center hidden">
            <svg class="animate-spin h-5 w-5 mr-3 inline" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Submitting your application...
          </p>
          <p id="errorMessage" class="text-red-600 text-center hidden"></p>
        </div>
        <form class="space-y-4" id="admissionsForm">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-blue-700 font-semibold mb-1" for="name">Full Name</label>
              <input type="text" id="name" name="name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
            </div>
            <div>
              <label class="block text-blue-700 font-semibold mb-1" for="dob">Date of Birth</label>
              <input type="date" id="dob" name="dob" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
            </div>
            <div>
              <label class="block text-blue-700 font-semibold mb-1" for="gender">Gender</label>
              <select id="gender" name="gender" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="">Select gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label class="block text-blue-700 font-semibold mb-1" for="address">Address</label>
              <input type="text" id="address" name="address" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
            </div>
            <div>
              <label class="block text-blue-700 font-semibold mb-1" for="guardian">Guardian's Name</label>
              <input type="text" id="guardian" name="guardian" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
            </div>
            <div>
              <label class="block text-blue-700 font-semibold mb-1" for="prevschool">Previous School/College</label>
              <input type="text" id="prevschool" name="prevschool" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
            </div>
            <div>
              <label class="block text-blue-700 font-semibold mb-1" for="photo">Upload Photo</label>
              <input type="file" id="photo" name="photo" accept="image/*" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 bg-white" />
            </div>
            <div>
              <label class="block text-blue-700 font-semibold mb-1" for="email">Email</label>
              <input type="email" id="email" name="email" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
            </div>
            <div>
              <label class="block text-blue-700 font-semibold mb-1" for="phone">Phone Number</label>
              <input type="tel" id="phone" name="phone" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
            </div>
            <div class="md:col-span-2">
              <label class="block text-blue-700 font-semibold mb-1" for="program">Program Interested In</label>
              <select id="program" name="program" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="">Select a program</option>
                <option value="BCA">BCA</option>
                <option value="BSc.CSIT">BSc.CSIT</option>
                <option value="BBS">BBS</option>
                <option value="+2 Science">+2 Science</option>
                <option value="+2 Management">+2 Management</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block text-blue-700 font-semibold mb-1" for="message">Message (optional)</label>
              <textarea id="message" name="message" rows="2" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
            </div>
          </div>
          <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white font-bold py-3 rounded-lg shadow hover:scale-105 hover:from-green-600 hover:to-blue-700 transition-all duration-200 mt-2">
            Submit
          </button>
        </form>
        <!-- Success message -->
        <div id="formSuccess" class="hidden mt-6">
          <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
            <p class="font-bold">Registration Successful!</p>
            <p>Thank you for registering. We will contact you soon.</p>
            <button onclick="location.href='index.html'" class="mt-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors">
              Return to Homepage
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    document.getElementById('admissionsForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const form = e.target;
      const submitBtn = document.getElementById('submitBtn');
      const loadingMsg = document.getElementById('loadingMessage');
      const errorMsg = document.getElementById('errorMessage');
      const formStatus = document.getElementById('formStatus');
      const formSuccess = document.getElementById('formSuccess');

      // Show loading state
      submitBtn.disabled = true;
      formStatus.classList.remove('hidden');
      loadingMsg.classList.remove('hidden');
      errorMsg.classList.add('hidden');

      try {
        const fileInput = form.photo;
        const file = fileInput.files[0];
        
        // File validation
        if (file && file.size > 5 * 1024 * 1024) {
          throw new Error('Photo size must be less than 5MB');
        }

        // Optimize image before storage
        const optimizedPhoto = file ? await optimizeImage(file) : '';

        const formData = {
          name: form.name.value,
          dob: form.dob.value,
          gender: form.gender.value,
          address: form.address.value,
          guardian: form.guardian.value,
          prevschool: form.prevschool.value,
          email: form.email.value,
          phone: form.phone.value,
          program: form.program.value,
          message: form.message.value,
          photo: optimizedPhoto,
          submissionDate: new Date().toISOString()
        };

        // Try to store with cleanup if needed
        await safelyStoreAdmission(formData);

        // Show success state
        form.classList.add('hidden');
        formSuccess.classList.remove('hidden');
        
      } catch (error) {
        // Show error state
        errorMsg.textContent = error.message || 'Error submitting form. Please try again.';
        errorMsg.classList.remove('hidden');
        loadingMsg.classList.add('hidden');
        submitBtn.disabled = false;
      }
    });

    // Helper function to optimize image
    async function optimizeImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            // Calculate new dimensions (max 800px width/height)
            let width = img.width;
            let height = img.height;
            const maxSize = 800;
            
            if (width > height && width > maxSize) {
              height = (height * maxSize) / width;
              width = maxSize;
            } else if (height > maxSize) {
              width = (width * maxSize) / height;
              height = maxSize;
            }

            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Convert to compressed JPEG
            resolve(canvas.toDataURL('image/jpeg', 0.6));
          };
          img.onerror = () => reject(new Error('Image optimization failed'));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error('File reading failed'));
        reader.readAsDataURL(file);
      });
    }

    // Helper function to safely store admission data
    async function safelyStoreAdmission(formData) {
      const MAX_ITEMS = 100; // Maximum number of stored applications
      let admissions = [];
      
      try {
        admissions = JSON.parse(localStorage.getItem('admissions') || '[]');
      } catch {
        admissions = [];
      }

      // Remove oldest entries if exceeding limit
      if (admissions.length >= MAX_ITEMS) {
        admissions = admissions.slice(-MAX_ITEMS + 1);
      }

      // Add new admission
      admissions.push(formData);

      try {
        localStorage.setItem('admissions', JSON.stringify(admissions));
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          // If storage is full, remove older entries until it fits
          while (admissions.length > 1) {
            admissions.shift(); // Remove oldest entry
            try {
              localStorage.setItem('admissions', JSON.stringify(admissions));
              break;
            } catch (e) {
              if (admissions.length === 1) {
                throw new Error('Unable to store application. Please contact support.');
              }
              continue;
            }
          }
        } else {
          throw new Error('Storage error. Please try again.');
        }
      }
    }

    // Add file size validation on input
    document.getElementById('photo').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && file.size > 5 * 1024 * 1024) {
        alert('Please select a photo smaller than 5MB');
        e.target.value = '';
      }
    });
  </script>
</body>
</html>
